# PVE 镜像转换工具 (VM & LXC)

## 简介
这是一个用于 Proxmox VE (PVE) 的自动化脚本，旨在简化将磁盘镜像文件（如 `.img` 或 `.img.gz`）转换为 PVE 虚拟机 (VM)，或将容器镜像文件（如 `.tar.gz`, `.tar.zst`, `.tar.xz`）转换为 PVE 容器 (LXC) 的过程。它会自动处理镜像选择、模式选择、ID 设置、存储选择、磁盘导入、启动配置以及 EFI 支持等步骤。

## 功能
-   **多类型镜像支持**: 自动检测并支持 `.img`, `.img.gz` (用于 VM) 和 `.tar.gz`, `.tar.zst`, `.tar.xz` (用于 LXC) 等多种镜像文件。
-   **多目录扫描**: 扫描当前目录、`/var/lib/vz/template/iso/` 和 `/var/lib/vz/template/cache/` 下的镜像文件。
-   **交互式选择**: 允许用户选择要转换的镜像文件，并选择转换为 VM 或 LXC 模式。
-   **VM 模式**:
    -   将 `.img` 或 `.img.gz` 镜像注入到已存在的 PVE 虚拟机中。
    -   自动配置磁盘启动项。
-   **LXC 模式**:
    -   支持将 `.tar.gz`, `.tar.zst`, `.tar.xz` 容器镜像直接创建为 LXC 容器。
    -   **智能转换**: 如果选择的是 `.img` 或 `.img.gz` 文件，脚本会自动将其转换为 LXC 模板格式并创建容器。
    -   **自定义配置**: 允许用户自定义容器 ID、名称、CPU 核心、内存、磁盘大小和网络桥接。
    -   自动配置容器网络为手动 IP。
-   **清理**: 自动清理转换过程中产生的临时文件。

## 使用方法

1.  **上传脚本**: 将 `pvezh.sh` 脚本上传到 PVE 主机，例如您的家目录。
2.  **赋予执行权限并运行**:
    ```bash
    chmod +x pvezh.sh
    ./pvezh.sh
    ```
    或者，如果您希望一键下载并执行：
    ```bash
    wget -O pvezh.sh https://raw.githubusercontent.com/chengege666/pvezh/main/pvezh.sh && chmod +x pvezh.sh && ./pvezh.sh
    ```
3.  **按照提示操作**: 脚本会引导您完成以下步骤：
    -   **选择镜像文件**: 脚本会列出检测到的所有 `.img`, `.img.gz`, `.tar.gz`, `.tar.zst`, `.tar.xz` 文件，请选择一个编号。
    -   **选择安装模式**:
        -   **[1] 虚拟机 (VM) 模式**:
            -   **输入目标 VM ID**: 此模式需要您提前在 PVE 中创建一个空的虚拟机。脚本会将选定的 `.img` 或 `.img.gz` 镜像注入到该虚拟机的 `scsi0` 磁盘，并设置其为启动盘。
        -   **[2] 容器 (LXC) 模式**:
            -   **配置容器参数**: 脚本会提示您输入容器 ID、名称、CPU 核心、内存、磁盘大小和网络桥接。
            -   **智能转换**: 如果您选择的是 `.img` 或 `.img.gz` 文件，脚本会自动将其转换为 LXC 模板格式，然后创建容器。如果选择的是 `.tar.gz`, `.tar.zst`, `.tar.xz` 文件，则直接用于创建容器。
4.  **确认并执行**: 确认配置信息后，脚本将自动执行转换和创建过程。
5.  **启动虚拟机/容器**: 转换完成后，您可以在 PVE 控制台启动新创建的虚拟机或容器。

## 默认配置
-   **VM 模式**:
    -   脚本将镜像注入到您指定的现有虚拟机中，不创建新的虚拟机。
-   **LXC 模式**:
    -   **CPU**: 1 核
    -   **内存**: 512 MB
    -   **磁盘大小**: 4 GB
    -   **网卡**: 桥接至 `vmbr0`
    -   **容器名称**: OpenWrt-LXC (可自定义)

## 注意事项
-   脚本需要 `qm` (Proxmox VE QEMU/KVM 管理工具) 和 `pct` (Proxmox VE 容器管理工具) 命令。
-   确保您有足够的权限执行脚本和在 PVE 上创建/修改虚拟机或容器。
-   **VM 模式**: 必须提前在 PVE 中创建一个空的虚拟机，脚本会将镜像注入到该虚拟机中。
-   **LXC 模式**:
    -   如果选择 `.img` 或 `.img.gz` 文件，脚本会尝试将其转换为 LXC 模板格式。此过程可能需要一些时间，具体取决于镜像大小和系统性能。
    -   转换过程中会使用回环设备挂载和 `tar` 打包，请确保系统环境支持。

## 贡献
欢迎对本项目进行贡献。如果您有任何改进建议或发现 Bug，请提交 Issue 或 Pull Request。

